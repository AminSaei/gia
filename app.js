const menuData = {
  "اسپرسو بار - عربیکا 100": {
    theme: { a: "#1f140f", b: "#5a3524", accent: "#f2c078", accent2: "#ffdfb5" },
    items: [
      ["اسپرسو", "121"],
      ["اسپرسو کن پانا", "146"],
      ["آمریکانو", "126"],
      ["کافی کریم", "151"],
      ["کورتادو", "133"],
      ["کاپوچینو", "133"],
      ["لاته", "147"],
      ["لاته جیا(لاته زعفران+خامه)", "190"],
      ["کارامل ماکیاتو", "172"],
      ["کافه کارامل", "212"],
      ["موکاچینو", "172"],
      ["موکا", "212"],
      ["موکا فندق", "187"],
      ["آفوگاتو", "178"],
      ["بادام زمینی/شکلات", "+25"],
      ["آیس پشن کافی", "159"],
      ["آیس آیریش کافی", "159"],
      ["آیس اورنج اسپرسو", "159"],
      ["آیس تونیک اسپرسو", "159"]
    ]
  },
  "اسپرسو بار - 50/50": {
    theme: { a: "#172025", b: "#2d4b57", accent: "#a7d8f0", accent2: "#d6f0ff" },
    items: [
      ["اسپرسو", "98"],
      ["اسپرسو کن پانا", "133"],
      ["آمریکانو", "103"],
      ["کافی کریم", "138"],
      ["کورتادو", "112"],
      ["کاپوچینو", "112"],
      ["لاته", "128"],
      ["کارامل ماکیاتو", "153"],
      ["کافه کارامل", "193"],
      ["موکاچینو", "153"],
      ["موکا", "193"],
      ["موکا فندق", "167"],
      ["آفوگاتو", "158"]
    ]
  },
  "اسپرسو بار - 70 روبوستا": {
    theme: { a: "#25170e", b: "#6a3c27", accent: "#ffd2a7", accent2: "#ffe7cc" },
    items: [
      ["اسپرسو", "85"],
      ["اسپرسو کن پانا", "110"],
      ["آمریکانو", "90"],
      ["کافی کریم", "115"],
      ["کورتادو", "99"],
      ["کاپوچینو", "99"],
      ["لاته", "115"],
      ["کارامل ماکیاتو", "180"],
      ["کافه کارامل", "180"],
      ["موکاچینو", "140"],
      ["موکا", "180"],
      ["موکا فندق", "155"],
      ["آفوگاتو", "135"]
    ]
  },
  "دمی و کلد برو": {
    theme: { a: "#12201a", b: "#2e5f49", accent: "#9fe2b8", accent2: "#d5ffe7" },
    items: [
      ["دمی V60", "180"],
      ["کلد برو کلاسیک", "170"],
      ["کلد برو ککتل", "180"]
    ]
  },
  "بار گرم": {
    theme: { a: "#2e0f14", b: "#682132", accent: "#ffc0cf", accent2: "#ffe1ea" },
    items: [
      ["هات چاکلت", "135"],
      ["هات چاکلت (فندوقی/نارگیلی)", "155"],
      ["هات چاکلت مارشمالو", "155"],
      ["شیر ارده", "130"],
      ["هات بیسکویت", "155"],
      ["وایت چاکلت", "135"],
      ["شیر پسته زعفران", "185"],
      ["شیر عسل دارچین", "110"],
      ["ماچا/اسپریرولینا لاته", "150"],
      ["شیر گرم", "70"]
    ]
  },
  "بار سرد": {
    theme: { a: "#0f1d30", b: "#1c4c76", accent: "#a5d7ff", accent2: "#d9eeff" },
    items: [
      ["آیس تی", "120"],
      ["شربت سنکنجبین خیار", "130"],
      ["لیموناد", "125"],
      ["موهیتو", "130"],
      ["اسموتی هندوانه", "110"],
      ["آیس چاکلت", "135"],
      ["آیس وایت چاکلت", "135"],
      ["شیر موز (پسته/نارگیل)", "110+25"],
      ["سودا لیمویی", "80"],
      ["آیس ماچا/اسپریرولینا لاته", "150"]
    ]
  },
  "شیک بار": {
    theme: { a: "#230f2b", b: "#533074", accent: "#e2b7ff", accent2: "#f1dcff" },
    items: [
      ["وانیل", "130"],
      ["شکلات", "180"],
      ["بیسکویت", "180"],
      ["بادام زمینی", "180"],
      ["پاپ کورن کارامل نمکی", "180"],
      ["کولا", "180"],
      ["نارگیل", "180"],
      ["پاستیل", "180"],
      ["چیز کیک", "180"],
      ["سنتی", "190"],
      ["قهوه", "170"],
      ["خامه", "+40"]
    ]
  },
  "چای و دمنوش": {
    theme: { a: "#18280f", b: "#395d1d", accent: "#caef9d", accent2: "#e9ffd0" },
    items: [
      ["چای سیاه", "64"],
      ["چای سبز", "95"],
      ["چای باقلوا", "174"],
      ["چای ترش", "105"],
      ["چای ماسالا", "135"],
      ["چای ترک", "145"],
      ["چای نعناع", "130"],
      ["چای انگلیسی (شیر و چای)", "110"],
      ["دمنوش میوه‌ای", "110"],
      ["دمنوش سلامت", "110"],
      ["دمنوش لمون گرس", "110"],
      ["دمنوش گل گاو زبان", "120"]
    ]
  },
  "کیک و شیرینی": {
    theme: { a: "#2a1c0d", b: "#785127", accent: "#ffd9a7", accent2: "#ffedd0" },
    items: [
      ["چیز کیک سن سباستین", "135"],
      ["چیز کیک لوتوس", "120"],
      ["کیک شکلاتی", "120"],
      ["کوکی پسته‌ای", "80"],
      ["کوکی رژیمی", "60"],
      ["باقلوا", "110"],
      ["باقلوا بستنی", "140"],
      ["کروسان ساده", "90"],
      ["کروسان شکلاتی", "120"]
    ]
  },
  "میان وعده": {
    theme: { a: "#191416", b: "#4a343d", accent: "#f4bfd5", accent2: "#ffe1ee" },
    items: [
      ["تست/کروسان پنیر آلبالو", "120"],
      ["تست/کروسان پنیر تخم مرغ", "170"],
      ["تست/کروسان تخم مرغ بیکن", "210"],
      ["تست/کروسان بادام (زمینی)/نوتلا و موز", "150"],
      ["تست/کروسان پنیر گردو و ریحان", "130"],
      ["کاتا خامه عسل گردو", "130"],
      ["چیپس و پنیر", "120"],
      ["آب دوغ خیار", "150"],
      ["اوتمیل", "160"],
      ["گرانولا ماست میوه‌ای", "150"],
      ["پنینی بیکن/بوقلمون", "260"],
      ["پنینی فلافل", "190"],
      ["پنینی بندری", "220"],
      ["پنینی مرغ (پستو/زرشک/بادم جان)", "260"],
      ["پنینی رست بیف", "310"]
    ]
  }
};

const categoriesEl = document.getElementById("categories");
const menuListEl = document.getElementById("menuList");
const currentCategoryEl = document.getElementById("currentCategory");
const clearChecksBtn = document.getElementById("clearChecks");
const searchInput = document.getElementById("searchInput");
const selectionMeta = document.getElementById("selectionMeta");
const goMenuBtn = document.getElementById("goMenuBtn");
const menuSection = document.getElementById("menuSection");
const aboutFlyout = document.getElementById("aboutFlyout");
const aboutToggle = document.getElementById("aboutToggle");

const checkedState = new Set(JSON.parse(localStorage.getItem("giaChecked") || "[]"));
const categoryNames = Object.keys(menuData);
let currentCategory = categoryNames[0];
let query = "";

function saveChecks() {
  localStorage.setItem("giaChecked", JSON.stringify([...checkedState]));
}

function hexToRgb(hex) {
  const value = hex.replace("#", "");
  const normalized = value.length === 3
    ? value.split("").map((c) => c + c).join("")
    : value;
  const int = Number.parseInt(normalized, 16);
  return {
    r: (int >> 16) & 255,
    g: (int >> 8) & 255,
    b: int & 255
  };
}

function mixWithWhite(hex, ratio) {
  const { r, g, b } = hexToRgb(hex);
  const mix = (v) => Math.round(v + (255 - v) * ratio);
  return `rgb(${mix(r)}, ${mix(g)}, ${mix(b)})`;
}

function applyTheme(theme) {
  const root = document.documentElement;
  root.style.setProperty("--menu-soft-1", mixWithWhite(theme.b, 0.68));
  root.style.setProperty("--menu-soft-2", mixWithWhite(theme.a, 0.74));
  root.style.setProperty("--menu-border", mixWithWhite(theme.b, 0.48));
  root.style.setProperty("--menu-tint", theme.accent);
  root.style.setProperty("--menu-glow", mixWithWhite(theme.accent, 0.55));
  root.style.setProperty("--accent-2", theme.accent2);
}

function renderCategories() {
  categoriesEl.innerHTML = "";

  categoryNames.forEach((name) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = `category-btn ${name === currentCategory ? "active" : ""}`;
    btn.textContent = name;
    btn.addEventListener("click", () => {
      currentCategory = name;
      renderCategories();
      renderMenu();
    });
    categoriesEl.appendChild(btn);
  });
}

function renderSelectionCount() {
  selectionMeta.textContent = `${checkedState.size} مورد انتخاب شده`;
}

function renderMenu() {
  const category = menuData[currentCategory];
  currentCategoryEl.textContent = currentCategory;
  applyTheme(category.theme);
  menuListEl.innerHTML = "";

  const filteredItems = category.items.filter(([title]) =>
    title.toLowerCase().includes(query.toLowerCase().trim())
  );

  if (!filteredItems.length) {
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.textContent = "آیتمی با این عبارت پیدا نشد";
    menuListEl.appendChild(empty);
    renderSelectionCount();
    return;
  }

  filteredItems.forEach(([title, price], index) => {
    const id = `${currentCategory}__${title}`;

    const card = document.createElement("label");
    card.className = "menu-item";
    card.style.setProperty("--i", String(index));

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = checkedState.has(id);
    checkbox.addEventListener("change", (event) => {
      if (event.target.checked) {
        checkedState.add(id);
      } else {
        checkedState.delete(id);
      }
      saveChecks();
      renderSelectionCount();
    });

    const info = document.createElement("div");
    const titleEl = document.createElement("p");
    titleEl.className = "item-title";
    titleEl.textContent = title;

    const priceEl = document.createElement("p");
    priceEl.className = "item-price";
    priceEl.textContent = `${price} هزار تومان`;

    info.append(titleEl, priceEl);
    card.append(checkbox, info);
    menuListEl.appendChild(card);
  });

  renderSelectionCount();
}

searchInput.addEventListener("input", (event) => {
  query = event.target.value || "";
  renderMenu();
});

clearChecksBtn.addEventListener("click", () => {
  checkedState.clear();
  saveChecks();
  renderMenu();
});

goMenuBtn.addEventListener("click", () => {
  const isOpen = menuSection.classList.contains("is-open");
  if (!isOpen) {
    menuSection.classList.add("is-open");
    setTimeout(() => {
      menuSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 120);
  } else {
    menuSection.scrollIntoView({ behavior: "smooth", block: "start" });
  }
});

if (aboutFlyout && aboutToggle) {
  aboutToggle.addEventListener("click", () => {
    const willOpen = !aboutFlyout.classList.contains("open");
    aboutFlyout.classList.toggle("open", willOpen);
    aboutToggle.setAttribute("aria-expanded", String(willOpen));
  });

  document.addEventListener("click", (event) => {
    if (!aboutFlyout.contains(event.target)) {
      aboutFlyout.classList.remove("open");
      aboutToggle.setAttribute("aria-expanded", "false");
    }
  });
}

renderCategories();
renderMenu();
